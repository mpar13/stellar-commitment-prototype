cd /workspaces/stellar-commitment-prototype

cat > README.md <<'EOF'
# Stellar Commitment Prototype

**Local Soroban prototype demonstrating a one-time, on-chain commitment + payout flow using Stellar.**

This repo implements a minimal but complete **commitment contract** on Stellar (Soroban), where users can:
- Read their on-chain state (eligible / claimed / locked / withdrawn)
- Execute a one-time payout (`claim_now`)
- Verify token balance changes (USDC via Stellar Asset Contract)
- Reset the demo (admin action) so the flow can be tested again

This is a **prototype** focused on clarity + reproducibility, not production hardening.

---

## What We Built (Current Features)

### Smart Contract (Soroban / Rust)
- Persistent per-user state stored on-chain:
  - `eligible`
  - `claimed_now`
  - `withdrawn`
  - `locked`, `locked_at`, `unlock_at`
  - `tier_id`
- Admin functions:
  - `init(admin, token_addr)`
  - `admin_set_tier(tier_id, tier)`
  - `admin_set_eligible(user, tier_id)`
- User function:
  - `claim_now(user)`
    Transfers payout tokens from the **contract** to the **user** (once), and updates state.

### Token Layer (Stellar Asset Contract)
- Local USDC asset deployed via:
  - `stellar contract asset deploy --asset "USDC:<ADMIN_ADDR>"`
- Contract is funded with tokens so it can pay out users.

### Frontend (Next.js)
- Dashboard:
  - Refresh state + display fields cleanly
  - Claim Now button
  - Reset Demo (Admin) button
  - Shows balance and last transaction debug output
- Uses `.env.local` (frontend) to point to the current deployed contract IDs and user address

---

## Repo Structure

stellar-commitment-prototype/
â”œâ”€â”€â”€ contract/
â”‚ â””â”€â”€â”€ commitment_contract/
â”‚  â”œâ”€â”€â”€ contracts/commitment/ # Soroban contract code (Rust)
â”‚  â”œâ”€â”€â”€ Cargo.toml
â”‚  â””â”€â”€â”€ .env.local # backend env (generated by script)
â”‚
â”œâ”€â”€â”€ frontend/
â”‚ â”œâ”€â”€â”€ pages/ # Next.js UI + API routes
â”‚ â”œâ”€â”€â”€ styles/
â”‚ â””â”€â”€â”€ .env.local # frontend env (generated by script)
â”‚
â””â”€â”€â”€ README.md

# Step 2 â€” Fund Identities, Deploy USDC + Commitment Contract, Set Tier + Eligibility

cd /workspaces/stellar-commitment-prototype/contract/commitment_contract

# Fund identities (safe to re-run)
stellar keys fund admin --network local >/dev/null 2>&1 || true
stellar keys fund user1 --network local >/dev/null 2>&1 || true
stellar keys fund user2 --network local >/dev/null 2>&1 || true
echo "Funded admin/user1/user2 âœ…"

# Addresses
ADMIN_ADDR="$(stellar keys address admin)"
USER2_ADDR="$(stellar keys address user2)"

# Deploy SAC token and save alias "token"
TOKEN_ID="$(stellar contract asset deploy \
  --network local \
  --source-account admin \
  --asset "USDC:$ADMIN_ADDR" \
  --alias token)"
echo "TOKEN_ID=$TOKEN_ID"

# Build WASM
cargo build --target wasm32v1-none --release >/dev/null
COMMIT_WASM="target/wasm32v1-none/release/commitment.wasm"

# Deploy commitment + save alias "commitment"
COMMIT_ID="$(stellar contract deploy --network local --source-account admin --wasm "$COMMIT_WASM")"
stellar contract alias remove commitment --network local >/dev/null 2>&1 || true
stellar contract alias add commitment --network local --id "$COMMIT_ID" >/dev/null
echo "COMMIT_ID=$COMMIT_ID"

# Init commitment
stellar contract invoke \
  --network local \
  --source-account admin \
  --id commitment \
  --send=yes \
  -- \
  init \
  --admin "$ADMIN_ADDR" \
  --token_addr "$TOKEN_ID" >/dev/null

# Tier + eligible
stellar contract invoke \
  --network local \
  --source-account admin \
  --id commitment \
  --send=yes \
  -- \
  admin_set_tier \
  --tier_id 0 \
  --tier '{"lock_secs":60,"payout_early":"1","payout_mature":"5","payout_now":"5"}' >/dev/null

stellar contract invoke \
  --network local \
  --source-account admin \
  --id commitment \
  --send=yes \
  -- \
  admin_set_eligible \
  --user "$USER2_ADDR" \
  --tier_id 0 >/dev/null

# Step 3 â€” Create Trustline for User2 + Fund Contract With USDC

cd /workspaces/stellar-commitment-prototype/contract/commitment_contract

# Trustline for user2
stellar tx new change-trust \
  --network local \
  --source-account user2 \
  --line "USDC:$ADMIN_ADDR" \
  --limit 1000000000 \
  --build-only > trust.xdr

stellar tx sign --network local --sign-with-key user2 trust.xdr > trust.signed.xdr
stellar tx send --network local trust.signed.xdr >/dev/null

# Fund contract with USDC (so claim_now can pay)
stellar contract invoke \
  --network local \
  --source-account admin \
  --id token \
  --send=yes \
  -- \
  transfer \
  --from "$ADMIN_ADDR" \
  --to "$COMMIT_ID" \
  --amount "1000" >/dev/null

# Step 4 â€” Write Backend + Frontend .env.local Files (Critical)

cd /workspaces/stellar-commitment-prototype/contract/commitment_contract

# Write backend env
cat > .env.local <<EOF
export STELLAR_NETWORK=local
export STELLAR_NETWORK_PASSPHRASE="Standalone Network ; February 2017"
export STELLAR_RPC_URL="http://localhost:8000/soroban/rpc"
ADMIN_ADDR=$ADMIN_ADDR
TOKEN_ID=$TOKEN_ID
COMMIT_ID=$COMMIT_ID
USER2_ADDR=$USER2_ADDR
EOF

# Write frontend env
cat > /workspaces/stellar-commitment-prototype/frontend/.env.local <<EOF
NEXT_PUBLIC_SOROBAN_RPC=http://localhost:8000/soroban/rpc
NEXT_PUBLIC_NETWORK_PASSPHRASE=Standalone Network ; February 2017
NEXT_PUBLIC_COMMIT_ID=$COMMIT_ID
NEXT_PUBLIC_TOKEN_ID=$TOKEN_ID
NEXT_PUBLIC_USER_ADDR=$USER2_ADDR
EOF

echo "âœ… Backend + Frontend env READY"
echo "Next claim command:"
echo "source .env.local && stellar contract invoke --network local --source-account user2 --id commitment --send=yes -- claim_now --user \"$USER2_ADDR\""

# Running the Frontend

cd /workspaces/stellar-commitment-prototype/frontend
npm install
npm run dev

# Open:

http://localhost:3000

# Quick Sanity Test (API)

cd /workspaces/stellar-commitment-prototype/frontend

echo "---- GET USER ----"
curl -s http://localhost:3000/api/get-user
echo ""

echo "---- CLAIM NOW ----"
curl -s http://localhost:3000/api/claim-now
echo ""

echo "---- GET USER (after) ----"
curl -s http://localhost:3000/api/get-user
echo ""

# Expected:

claim_now returns "5" (payout)

user state flips claimed_now: true and withdrawn: true

balance becomes "5"

ðŸŽ›ï¸ Demo Flow

Click Refresh â†’ reads contract state

Click Claim Now â†’ user receives USDC (one time)

Balance updates immediately

Click Reset Demo (Admin) â†’ restores eligibility for testing

âš ï¸ Known Limitations (Intentional)

Local network only (not testnet/mainnet)

No wallet integrations (keys are CLI-managed)

No production auth / permissions

Reset flow is admin-only but exposed for demo

These are explicit tradeoffs to keep the prototype focused.

ðŸ§ª Why This Is Grant-Appropriate

Clear problem scope

On-chain enforcement (not UI tricks)

Fully reproducible environment

Demonstrates Soroban + token flows

Easily extensible (locks, streaming, DAO rules, attestations)

This prototype is meant to be a foundation, not a finished product.

ðŸ“Œ Next Logical Extensions (Future Work)

Wallet-based auth (Freighter)

Time-based unlocks (lock_secs)

Streaming payouts

Attestation / oracle hooks

Multi-user dashboards

Deployment to testnet